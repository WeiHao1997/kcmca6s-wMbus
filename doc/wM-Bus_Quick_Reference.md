# wM-Bus协议快速参考卡

## 传输模式速查

| 模式 | 频率(MHz) | 速率(kbps) | 功率(mW) | 应用场景 |
|------|-----------|------------|----------|----------|
| **T** | 868.95 | 100 | ≤25 | 定期抄表 |
| **C** | 868.95 | 100 | ≤25 | 实时控制 |
| **S** | 868.3 | 32.768 | ≤25 | 固定设备 |
| **N** | 169.4-169.475 | 2.4/4.8/19.2 | ≤500 | 长距离 |
| **R** | 868.33 | 4.8 | ≤25 | 地下设备 |
| **F** | 433.82 | 2.4 | ≤10 | 便携设备 |

## 帧格式

### 标准帧
```
68	LL	LL	68	C	[地址8字节]	CI	[数据]	16
```

### 字段说明
- **68**: 起始字符
- **LL**: 长度字段
- **C**: 控制字段
- **CI**: 控制信息
- **16**: 结束字符

## 控制字段 (C-Field)

### C字段结构 (EN 13757标准)
```
Bit: 7	6	5	4	3	2	1	0
     RES	PRM	FCB	FCV	   功能码(4位)
              ACD	DFC
```
- **RES**: 保留位(固定为0)
- **PRM**: 主/从标识 (1=主机, 0=从机)
- **FCB/ACD**: 帧计数位/访问需求
- **FCV/DFC**: 帧计数有效/数据流控制

| 功能码 | 名称 | 方向 | PRM | RES | 说明 |
|--------|------|------|-----|-----|------|
| 0 | SND-NKE | M→S | 1 | 0 | 链路复位 |
| 1 | SND-NR | M→S | 1 | 0 | 发送无响应 |
| 2 | SND-UD | M→S | 1 | 0 | 发送用户数据 |
| 3 | REQ-UD1 | M→S | 1 | 0 | 请求数据1 |
| 4 | REQ-UD2 | M→S | 1 | 0 | 请求数据2 |
| 5 | RSP-UD | S→M | 0 | 0 | 响应数据 |
| 6 | CNF-IR | S→M | 0 | 0 | 确认安装 |
| 7 | CNF-NR | S→M | 0 | 0 | 确认无响应 |
| 8 | ACC-NR | S→M | 0 | 0 | 访问无响应 |

## CI字段 (Control Information)

### 常用CI值
| CI值 | 名称 | 说明 |
|------|------|------|
| 0x51 | 应用层数据 | 直接数据记录 |
| 0x7A | 短传输层 | 4字节STL头部 |
| 0x8A | 长传输层 | 8字节LTL头部 |

### 扩展链路层CI值
| CI值 | 长度 | 结构 | 服务功能 |
|------|------|------|----------|
| **0x8C** | 3-20字节 | CC, ACC, 可变字段 | 可选择服务 |
| **0x8D** | 2字节 | CC, ACC | 通信控制，同步 |
| **0x8E** | 8字节 | CC, ACC, SN, PayloadCRC | 通信控制，同步，加密 |
| **0x8F** | 10字节 | CC, ACC, M2, A2 | 通信控制，同步，目标地址 |
| **0x8G** | 16字节 | CC, ACC, M2, A2, SN, PayloadCRC | 完整功能 |

### 扩展链路层字段
#### CC字段 (Communication Control)
```
Bit: 7	6	5	4	3	2	1	0
     扩展	安全	路由	流控	确认	优先	重传	同步
```

#### ACC字段 (Access Control)
```
Bit: 7	6	5	4	3	2	1	0
     保留	服务	网络	设备	会话	加密	认证	权限
```

### STL头部 (CI=0x7A)
```
字节: 0    1    2    3
     AN   ST   CW   CW
```
- **AN**: 访问号
- **ST**: 状态字节
- **CW**: 配置字(16位)

## 设备类型

| 类型 | 设备 | 类型 | 设备 |
|------|------|------|------|
| 0x00 | 其他 | 0x07 | 水表 |
| 0x01 | 油表 | 0x08 | 热成本分配器 |
| 0x02 | 电表 | 0x09 | 压缩空气 |
| 0x03 | 气表 | 0x0A | 冷却表 |
| 0x04 | 热表 | 0x0B | 冷却表 |
| 0x05 | 蒸汽表 | 0x0C | 热表 |
| 0x06 | 温水表 | 0x0D | 热/冷表 |

## DIF编码

| 编码 | 长度 | 类型 |
|------|------|------|
| 0x01 | 1字节 | 8位整数 |
| 0x02 | 2字节 | 16位整数 |
| 0x04 | 4字节 | 32位整数 |
| 0x0C | 4字节 | 32位BCD |
| 0x4C | 4字节 | 32位BCD+存储号1 |

## VIF编码

### 体积
| VIF | 单位 | 倍数 |
|-----|------|------|
| 0x13 | L | 10⁻³ m³ |
| 0x14 | m³ | 10⁻² m³ |
| 0x15 | m³ | 10⁻¹ m³ |
| 0x16 | m³ | 1 m³ |

### 流量
| VIF | 单位 | 倍数 |
|-----|------|------|
| 0x3B | L/h | 10⁻³ m³/h |
| 0x3C | m³/h | 10⁻² m³/h |
| 0x3E | m³/h | 1 m³/h |

### 能量
| VIF | 单位 | 倍数 |
|-----|------|------|
| 0x03 | Wh | 1 Wh |
| 0x06 | kWh | 1 kWh |
| 0x07 | kWh | 10 kWh |

### 时间
| VIF | 含义 |
|-----|------|
| 0x6C | 时间点(秒) |
| 0x6D | 时间点(分钟) |
| 0x6E | 时间点(小时) |
| 0x6F | 时间点(天) |

## 加密模式

| 模式 | 算法 | 密钥长度 | 状态 |
|------|------|----------|------|
| 0 | 无加密 | - | 标准 |
| 1 | DES | 64位 | 已弃用 |
| 5 | AES-128 | 128位 | 推荐 |
| 7 | AES-256 | 256位 | 高安全 |

## 常用数据记录示例

### 水表体积读数
```
0C 13 39 30 00 00  // 32位BCD + 体积(升) = 12.345 L
```

### 流量测量
```
04 3B 96 00 00 00  // 32位整数 + 流量 = 150 L/h
```

### 时间戳
```
04 6D 32 37 1F 15  // 32位整数 + 时间(分钟)
```

### 历史数据
```
4C 13 C0 2B 00 00  // 32位BCD + 体积(升) + 存储号1
```

## 错误码

| 错误 | 代码 | 说明 |
|------|------|------|
| CRC错误 | 0x01 | 数据校验失败 |
| 长度错误 | 0x02 | 帧长度不匹配 |
| 地址错误 | 0x03 | 设备地址错误 |
| 命令错误 | 0x04 | 不支持的命令 |
| 超时错误 | 0x05 | 响应超时 |
| 加密错误 | 0x06 | 加密解密失败 |

## 调试工具

### 在线工具
- **wmbusmeters.org**: 数据解析
- **OMS Test Tool**: 协议测试

### 硬件工具
- **Protocol Analyzer**: 协议分析
- **RF Tester**: 射频测试
- **Power Meter**: 功耗测试

## 开发检查清单

### 硬件设计
- [ ] 射频参数配置正确
- [ ] 天线匹配良好
- [ ] 功耗优化
- [ ] EMC兼容性

### 软件实现
- [ ] 协议栈完整
- [ ] 错误处理机制
- [ ] 加密实现
- [ ] 状态机设计

### 测试验证
- [ ] 单元测试
- [ ] 集成测试
- [ ] 互操作测试
- [ ] 性能测试

### 认证准备
- [ ] CE/FCC认证
- [ ] OMS认证
- [ ] 能效认证
- [ ] 安全认证

## 性能优化建议

### 功耗优化
1. 调整发送间隔
2. 优化数据包大小
3. 使用低功耗模式
4. 合理配置射频功率

### 可靠性优化
1. 启用重传机制
2. 实施错误检测
3. 优化天线设计
4. 减少干扰源

### 距离优化
1. 提高发射功率
2. 改善接收灵敏度
3. 优化天线增益
4. 选择合适的模式

## 常见问题解决

### 通信失败
1. 检查射频参数
2. 验证设备地址
3. 确认加密配置
4. 分析信号强度

### 功耗过高
1. 检查发送间隔
2. 优化数据包
3. 调整射频功率
4. 检查休眠模式

### 数据错误
1. 验证DIF/VIF编码
2. 检查数据长度
3. 确认字节序
4. 验证校验机制

---

*快速参考卡 v1.0 - 基于EN 13757和OMS标准*
